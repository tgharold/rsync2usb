#!/bin/bash

# exit immediately on errors
set -e
# error out if uninitialized variable is used
set -u

# http://stackoverflow.com/questions/59895/can-a-bash-script-tell-what-directory-its-stored-in
SCRIPTDIR=$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )
SCRIPTDIR="${SCRIPTDIR}/includes"
source "${SCRIPTDIR}/globals"

# Configuration Variables:
#
# GLOBAL / USER:
#
# job_dir - location of job files
# lvm_snapshotadd - Amount (in GiB) to add to the LV when doing the snapshot
# lvm_thinflag - (possibly not needed), 'true' if LV is a "thin" LV
# lvm_vgname - Volume Group name which contains the LV (optional)
# minimum_free_space - Measured in GiB (gigabytes), error if target has less, warn at 2x or less
# minimum_free_inodes - Error if target file system has less, warn at 2x or less
# usb_base - directory where USB backup drives are mounted
# usb_prefix - space delimited list of letters/numbers used as prefixes
# usb_filename - the unchanging portion of the mount directory
# usb_suffix - space delimited list of letters/numbers used as suffixes
# verbosity - 0=none, 1=some info, 2=debug level
#
# JOB SPECIFIC:
#
# backup_base - Location of the directory to be backed up
# backup_dir - A directory inside the backup_base location
# lvm_lvname - Logical Volume name of the backup_base directory (optional)
# usb_dir - Directory name to use on USB drive (defaults to backup_dir)

# Set default values
Configuration[backup_base]="/backup"
Configuration[backup_dir]="test"
Configuration[job_dir]="~/sync2usb.d"
Configuration[lvm_lvname]=""
Configuration[lvm_snapshotadd]=10
Configuration[lvm_thinflag]=true
Configuration[lvm_vgname]=""
Configuration[minimum_free_space]=25
Configuration[minimum_free_inodes]=50000
Configuration[usb_base]="/mnt"
Configuration[usb_dir]=""
Configuration[usb_prefix]=""
Configuration[usb_filename]="BACKUP"
Configuration[usb_suffix]="1 2 3 4 5 6 7 8 9"
Configuration[verbosity]=2

source "${SCRIPTDIR}/config_error"
source "${SCRIPTDIR}/list_variables"
source "${SCRIPTDIR}/push_config_variables"
source "${SCRIPTDIR}/pop_config_variables"
source "${SCRIPTDIR}/trim"
source "${SCRIPTDIR}/read_config_file"
source "${SCRIPTDIR}/shuffle_JobFiles"

list_variables "Default Variables:"

read_config_file ${GlobalConfigFilename}
list_variables "Variables after ${GlobalConfigFilename}"
read_config_file ${UserConfigFilename}
list_variables "Variables after ${UserConfigFilename}"

push_config_variables
pop_config_variables
